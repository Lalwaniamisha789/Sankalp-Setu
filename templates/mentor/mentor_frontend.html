<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>AI Business Mentor</title>
  <link rel="stylesheet" href="/static/css/matcher_mentor.css" />
  <style>
    .mentor-result {
      background: #f9f9fb;
      color: #222;
      padding: 24px;
      border-radius: 12px;
      font-size: 1rem;
      line-height: 1.6;
      max-width: 800px;
      margin: 24px auto;
    }

    .mentor-result ul {
      padding-left: 20px;
    }

    .mentor-result li {
      margin-bottom: 6px;
    }

    .mentor-result strong {
      color: #b266ff;
    }

    .action-buttons button {
    background: #a259ff;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
    min-width: 160px;
    transition: background 0.2s;
    }

    .action-buttons button:hover {
    background: #933bff;
    }


    button.find-btn,
    #speak-btn,
    #record-btn {
      background: #a259ff;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }

    button.find-btn:hover,
    #speak-btn:hover,
    #record-btn:hover {
      background: #933bff;
    }
  </style>
</head>
<body class="dark-bg">
  <header class="header">
    <div class="logo">
      <span class="icon">ðŸ’¡</span>
      <span class="brand">Sankalp <span class="highlight">Setu</span></span>
    </div>
    <nav>
      <a href="/">Home</a>
      <a href="/matcher/frontend/">Matcher</a>
    </nav>
  </header>

  <main>
    <h1 class="main-title">AI Business Mentor</h1>
    <p class="desc">
      Describe your business idea in any language. Get feasibility, scheme suggestions, and a startup plan from our AI Mentor.
    </p>

    <section class="search-section">
      <textarea
        id="mentor-query"
        class="search-box"
        rows="4"
        placeholder="Describe your business idea..."
      ></textarea>
      <div class="action-buttons">
        <button id="mentor-btn">Talk to AI Mentor</button>
        <button id="record-btn">Speak</button>
      </div>      
    </section>

    <div id="mentor-response" style="margin-top: 30px; color: #eee; padding: 20px;"></div>
    <div style="text-align: center;">
      <button id="speak-btn" style="display: none;">Read Aloud</button>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("mentor-btn");
      const recordBtn = document.getElementById("record-btn");
      const queryBox = document.getElementById("mentor-query");
      const resultDiv = document.getElementById("mentor-response");
      const speakBtn = document.getElementById("speak-btn");
      let lastPlainText = "";

      btn.onclick = async function () {
        const query = queryBox.value.trim();
        if (!query) {
          resultDiv.innerHTML = "<p>Please enter a business idea.</p>";
          speakBtn.style.display = "none";
          return;
        }

        resultDiv.innerHTML = "<p>Thinking...</p>";
        speakBtn.style.display = "none";

        const response = await fetch("/mentor/mentor-chatbot/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken")
          },
          body: JSON.stringify({ query })
        });

        if (!response.ok) {
          resultDiv.innerHTML = "<p style='color:red;'>Something went wrong. Try again.</p>";
          return;
        }

        const data = await response.json();
        const formatted = formatMentorResponse(data.response);
        resultDiv.innerHTML = `<div class="mentor-result">${formatted}</div>`;
        lastPlainText = stripHTML(data.response);
        speakBtn.style.display = "inline-block";
      };

      speakBtn.onclick = () => {
        const synth = window.speechSynthesis;
        synth.cancel();
        const speech = new SpeechSynthesisUtterance(lastPlainText);
        speech.lang = detectHindi(lastPlainText) ? "hi-IN" : "en-IN";
        speech.rate = 1;
        speech.pitch = 1;

        const voices = synth.getVoices();
        const preferred = voices.find((v) => v.lang.includes(speech.lang));
        if (preferred) speech.voice = preferred;

        synth.speak(speech);
      };

      recordBtn.onclick = () => {
        const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Recognition) {
          alert("Your browser does not support voice recognition.");
          return;
        }

        const recognition = new Recognition();
        recognition.lang = "hi-IN"; // Or switch dynamically based on user profile
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        resultDiv.innerHTML = "<p>Listening... Please speak now.</p>";

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          queryBox.value = transcript;
          resultDiv.innerHTML = "<p>Captured. Click 'Talk to AI Mentor' to proceed.</p>";
        };

        recognition.onerror = (event) => {
          resultDiv.innerHTML = `<p style="color:red;">Error: ${event.error}</p>`;
        };

        recognition.start();
      };

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      function formatMentorResponse(text) {
        const formatted = text
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')    // Bold
            .replace(/^\s*â€¢\s*(.+)$/gm, '<li>$1</li>')              // Convert â€¢ bullets
            .replace(/\* (.+)/g, '<li>$1</li>')                     // Fallback for * bullets
            .replace(/(\d+\.\s)/g, '<br><strong>$1</strong>')       // Numbered steps
            .replace(/\n{2,}/g, '<br><br>')                         // Paragraph spacing
            .replace(/\n/g, '<br>');                                // Line breaks
        return `<ul>${formatted}</ul>`;
        }


      function stripHTML(html) {
        const div = document.createElement("div");
        div.innerHTML = html;
        return div.textContent || div.innerText || "";
      }

      function detectHindi(text) {
        return /[à¤€-à¥¿]/.test(text);
      }

      window.speechSynthesis.onvoiceschanged = () => {
        window.speechSynthesis.getVoices();
      };
    });
  </script>
</body>
</html>
